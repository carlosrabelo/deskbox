# ==============================================================================
# Deskbox Desktop Environment - Docker Compose Configuration
# ==============================================================================
# Defines remote desktop environment based on Debian 12 (Bookworm) + XFCE4 + XRDP
# Access via Remote Desktop Protocol (RDP) on port 3389
# ==============================================================================

services:

  deskbox:
    # Builds image locally using multi-stage Dockerfile
    build:
      context: . # Project root as context
      dockerfile: docker/Dockerfile # Dockerfile location

    image: ${DOCKER_USER}/${IMAGE_NAME}:${VERSION} # Image name with version tag

    container_name: deskbox # Fixed container name

    hostname: deskbox # Container hostname

    # Exposes RDP (Remote Desktop Protocol) port and SSH port
    ports:
      - "${RDP_BIND_ADDRESS:-0.0.0.0}:3389:3389" # RDP - Configurable bind address
      - "2222:22" # SSH

    # Restarts automatically except if manually stopped
    restart: unless-stopped

    # Environment variables passed to the container
    environment:
      - TZ=${TZ} # System timezone
      - USER_PASSWORD=${USER_PASSWORD:-} # RDP password (fallback if no secrets)
      - HOSTNAME=deskbox # Container hostname
      - SECURITY_MODE=${SECURITY_MODE:-development} # Security mode

    # Isolated network for inter-container communication
    networks:
      - deskbox-network

    # Mounts host directory to persist user data
    volumes:
      - /mnt/deskbox/home:/home # Persists home directories
      - /mnt/deskbox/logs:/var/log/deskbox # Persists Deskbox logs

    # Shared memory for GUI applications (prevents crashes)
    shm_size: "${SHM_SIZE:-1g}"

    # Resource limits (configurable)
    mem_limit: "${MEMORY_LIMIT:-4096m}"
    cpus: "${CPU_LIMIT:-2.0}"

    # Health check to ensure XRDP is running properly
    healthcheck:
      test: [ "CMD", "pgrep", "-x", "xrdp" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Labels for better organization and monitoring
    labels:
      - "com.deskbox.version=${VERSION}"
      - "com.deskbox.environment=${ENVIRONMENT:-development}"
      - "com.deskbox.service=remote-desktop"
      - "com.deskbox.security-mode=${SECURITY_MODE:-development}"

# ==============================================================================
# Networks
# ==============================================================================
networks:

  deskbox-network:
    name: deskbox-network # Explicit network name
    driver: bridge # Default driver for local communication
